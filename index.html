<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Agenda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: auto repeat(7, 1fr);
            grid-template-rows: repeat(24, 60px);
        }
        .time-label {
            grid-column: 1;
            text-align: right;
            padding-right: 10px;
            font-size: 12px;
            color: #6b7280;
            position: relative;
            top: -8px;
        }
        .day-column {
            position: relative;
            border-right: 1px solid #e5e7eb;
            border-top: 1px solid #e5e7eb;
        }
        .event-card {
            position: absolute;
            width: 100%;
            z-index: 10;
            padding: 4px;
            overflow: hidden;
            border-radius: 4px;
            color: white;
            font-size: 12px;
            cursor: grab;
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .event-card:hover {
            opacity: 0.9;
        }
        .event-card.completed {
            text-decoration: line-through;
            opacity: 0.7;
        }
        .event-icons {
            display: flex;
            gap: 4px;
            background: rgba(0,0,0,0.2);
            padding: 2px;
            border-radius: 4px;
            position: absolute;
            bottom: 4px;
            right: 4px;
        }
        .event-icons svg {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .monthly-view-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            min-height: 600px;
        }
        .monthly-day-cell {
            border: 1px solid #e5e7eb;
            padding: 4px;
        }
        .monthly-day-cell.other-month {
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header -->
    <header class="bg-white shadow-md p-4 flex justify-between items-center flex-wrap gap-4">
        <h1 class="text-2xl font-bold text-gray-800">My Agenda</h1>
        <div class="flex items-center gap-2">
            <input type="text" id="search-bar" placeholder="Search events..." class="border border-gray-300 p-2 rounded-lg">
        </div>
        <div>
            <button id="daily-view-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-l">Day</button>
            <button id="weekly-view-btn" class="bg-blue-500 text-white font-bold py-2 px-4">Week</button>
            <button id="monthly-view-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-r">Month</button>
        </div>
        <div>
            <button id="prev-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-l"> &lt; </button>
            <button id="next-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-r"> &gt; </button>
            <button id="download-png" class="ml-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded"> Download as PNG </button>
        </div>
    </header>

    <main id="calendar-container" class="p-4">
        <div id="calendar-header" class="grid grid-cols-[auto_repeat(7,_1fr)] text-center font-bold text-gray-600 mb-2">
            <!-- Headers will be generated by JS -->
        </div>
        <div id="calendar-body" class="bg-white rounded-lg shadow">
            <!-- Calendar grid will be generated by JS -->
        </div>
    </main>
    
    <section class="p-4">
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Weekly Statistics</h2>
            <div id="stats-container"></div>
        </div>
    </section>

    <!-- Modals -->
    <div id="event-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">New Event</h2>
            <form id="event-form">
                <input type="hidden" id="event-id">
                <div class="mb-4">
                    <label for="event-title" class="block text-gray-700 font-medium mb-2">Event Title</label>
                    <input type="text" id="event-title" class="w-full border border-gray-300 p-2 rounded-lg" required>
                </div>
                <div class="flex items-center gap-4 mb-4">
                    <input type="checkbox" id="all-day-checkbox" class="h-4 w-4">
                    <label for="all-day-checkbox">All-day event</label>
                </div>
                <div id="time-inputs" class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="start-time" class="block text-gray-700 font-medium">Start Time</label>
                        <input type="time" id="start-time" class="w-full border p-2 rounded-lg" required step="900">
                    </div>
                    <div>
                        <label for="end-time" class="block text-gray-700 font-medium">End Time</label>
                        <input type="time" id="end-time" class="w-full border p-2 rounded-lg" required step="900">
                    </div>
                </div>
                 <div class="mb-4">
                    <label for="recurrence" class="block text-gray-700 font-medium">Recurring</label>
                    <select id="recurrence" class="w-full border p-2 rounded-lg">
                        <option value="none">None</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
                <input type="hidden" id="event-date">
                 <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Category</label>
                    <div id="category-picker" class="flex flex-wrap gap-2"></div>
                </div>
                 <div class="mb-6">
                    <label for="custom-color" class="block text-gray-700 font-medium mb-2">Custom Color (optional)</label>
                    <input type="color" id="custom-color" class="w-full h-10 p-1 border rounded-lg">
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="delete-event" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg hidden">Delete</button>
                    <button type="button" id="cancel-event" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="task-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
             <h2 class="text-2xl font-bold mb-6">Tasks for <span id="task-modal-title"></span></h2>
             <div id="task-list" class="space-y-2 mb-4 max-h-60 overflow-y-auto"></div>
             <div class="flex gap-2">
                <input type="text" id="new-task-input" placeholder="Add a new task..." class="flex-grow border p-2 rounded-lg">
                <button id="add-task-btn" class="bg-blue-500 text-white p-2 rounded-lg">Add</button>
             </div>
             <button id="close-task-modal" class="mt-6 bg-gray-300 py-2 px-4 rounded-lg">Close</button>
        </div>
    </div>
    
    <div id="info-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
         <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
             <h2 class="text-2xl font-bold mb-6">Notes for <span id="info-modal-title"></span></h2>
             <textarea id="info-textarea" class="w-full h-40 border p-2 rounded-lg mb-4"></textarea>
             <div class="flex justify-end gap-2">
                 <button id="cancel-info-modal" class="bg-gray-300 py-2 px-4 rounded-lg">Cancel</button>
                 <button id="save-info-modal" class="bg-blue-500 text-white py-2 px-4 rounded-lg">Save</button>
             </div>
         </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Existing constants...
            const calendarHeader = document.getElementById('calendar-header');
            const calendarBody = document.getElementById('calendar-body');
            const eventModal = document.getElementById('event-modal');
            const eventForm = document.getElementById('event-form');
            const modalTitle = document.getElementById('modal-title');
            const deleteButton = document.getElementById('delete-event');
            const statsContainer = document.getElementById('stats-container');
            
            // New constants
            const taskModal = document.getElementById('task-modal');
            const infoModal = document.getElementById('info-modal');
            const allDayCheckbox = document.getElementById('all-day-checkbox');
            const timeInputs = document.getElementById('time-inputs');
            
            let currentView = 'weekly'; // 'daily', 'weekly', 'monthly'
            let currentDate = new Date();
            let events = JSON.parse(localStorage.getItem('agendaEvents_v2')) || [];
            let editingEventId = null;

            const categories = [
                { name: 'Sleep', color: '#1e3a8a' },
                { name: 'Work', color: '#b91c1c' },
                { name: 'Leisure', color: '#047857' },
                { name: 'Exercise', color: '#7c3aed' },
                { name: 'Other', color: '#6b7280' }
            ];
            
            function initApp() {
                initNotifications();
                render();
                addEventListeners();
            }

            // --- NOTIFICATION LOGIC (Unchanged) ---
            function initNotifications() {
                if ('Notification' in window && Notification.permission !== 'denied') {
                    Notification.requestPermission();
                }
            }

            function scheduleNotifications() {
                // This logic correctly sets up future notifications.
                // It's called after events are saved or loaded.
                const now = new Date();
                events.forEach(event => {
                    const eventStart = new Date(event.start);
                    const notificationTime = new Date(eventStart.getTime() - 5 * 60000);
                    if (notificationTime > now && !event.isCompleted) {
                        const timeUntilNotification = notificationTime.getTime() - now.getTime();
                        setTimeout(() => {
                            if (Notification.permission === 'granted') {
                                new Notification(event.title, {
                                    body: `Starts at ${eventStart.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`,
                                    icon: 'https://placehold.co/32x32/000000/FFFFFF?text=ðŸ””'
                                });
                            }
                        }, timeUntilNotification);
                    }
                });
            }
            
            // --- CORE RENDER LOGIC ---
            function render() {
                switch(currentView) {
                    case 'daily':
                        renderDailyView();
                        break;
                    case 'weekly':
                        renderWeeklyView();
                        break;
                    case 'monthly':
                        renderMonthlyView();
                        break;
                }
                updateStats();
                scheduleNotifications();
            }

            function renderWeeklyView() {
                calendarBody.innerHTML = '';
                calendarHeader.innerHTML = '';
                calendarBody.className = 'calendar-grid bg-white rounded-lg shadow';
                calendarHeader.className = 'grid grid-cols-[auto_repeat(7,_1fr)] text-center font-bold text-gray-600 mb-2';

                const weekStart = getWeekStart(currentDate);
                
                // Render headers
                const timeCol = document.createElement('div');
                calendarHeader.appendChild(timeCol);
                for (let i = 0; i < 7; i++) {
                    const day = new Date(weekStart);
                    day.setDate(weekStart.getDate() + i);
                    const dayHeader = document.createElement('div');
                    dayHeader.textContent = `${day.toLocaleDateString('en-US', { weekday: 'short' })} ${day.getDate()}`;
                    calendarHeader.appendChild(dayHeader);
                }

                // Render time labels
                for (let hour = 0; hour < 24; hour++) {
                    const timeLabel = document.createElement('div');
                    timeLabel.className = 'time-label';
                    timeLabel.textContent = `${hour.toString().padStart(2, '0')}:00`;
                    timeLabel.style.gridRow = hour + 1;
                    calendarBody.appendChild(timeLabel);
                }
                
                // Render day columns
                for (let i = 0; i < 7; i++) {
                    const day = new Date(weekStart);
                    day.setDate(weekStart.getDate() + i);
                    const dayColumn = createDayColumn(day);
                    dayColumn.style.gridColumn = i + 2;
                    calendarBody.appendChild(dayColumn);
                }
                renderEvents();
            }
            
            function renderDailyView() {
                 calendarBody.innerHTML = '';
                calendarHeader.innerHTML = '';
                calendarBody.className = 'calendar-grid bg-white rounded-lg shadow'
                calendarBody.style.gridTemplateColumns = 'auto 1fr';
                calendarHeader.className = 'grid grid-cols-[auto_1fr] text-center font-bold text-gray-600 mb-2';

                // Render Header
                const timeCol = document.createElement('div');
                calendarHeader.appendChild(timeCol);
                const dayHeader = document.createElement('div');
                dayHeader.textContent = `${currentDate.toLocaleDateString('en-US', { weekday: 'long' })} ${currentDate.getDate()}`;
                calendarHeader.appendChild(dayHeader);


                // Render time labels
                for (let hour = 0; hour < 24; hour++) {
                    const timeLabel = document.createElement('div');
                    timeLabel.className = 'time-label';
                    timeLabel.textContent = `${hour.toString().padStart(2, '0')}:00`;
                    timeLabel.style.gridRow = hour + 1;
                    calendarBody.appendChild(timeLabel);
                }
                
                // Render day column
                const dayColumn = createDayColumn(currentDate);
                dayColumn.style.gridColumn = 2;
                calendarBody.appendChild(dayColumn);
                
                renderEvents();
            }

            function renderMonthlyView() {
                calendarBody.innerHTML = '';
                calendarHeader.innerHTML = '';
                calendarBody.className = 'monthly-view-grid bg-white rounded-lg shadow';
                calendarHeader.className = 'grid grid-cols-7 text-center font-bold text-gray-600 mb-2';
                
                const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                daysOfWeek.forEach(day => {
                    const dayHeader = document.createElement('div');
                    dayHeader.textContent = day;
                    calendarHeader.appendChild(dayHeader);
                });
                
                const monthStart = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                const monthEnd = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
                const startDate = getWeekStart(monthStart);

                for(let i = 0; i < 42; i++) {
                    const cellDate = new Date(startDate);
                    cellDate.setDate(startDate.getDate() + i);
                    const cell = document.createElement('div');
                    cell.className = 'monthly-day-cell h-24 overflow-auto';
                    if (cellDate.getMonth() !== currentDate.getMonth()) {
                        cell.classList.add('other-month');
                    }
                    cell.innerHTML = `<div class="font-bold">${cellDate.getDate()}</div>`;
                    cell.dataset.date = cellDate.toISOString().split('T')[0];
                    cell.addEventListener('click', () => openModal(cell.dataset.date));
                    calendarBody.appendChild(cell);
                }
                 renderEvents();
            }
            
            function createDayColumn(date) {
                const dayColumn = document.createElement('div');
                dayColumn.className = 'day-column';
                dayColumn.dataset.date = date.toISOString().split('T')[0];
                dayColumn.style.gridRow = '1 / 25';
                
                dayColumn.addEventListener('click', (e) => {
                    if (e.target === dayColumn) {
                        openModal(date.toISOString().split('T')[0], e.offsetY);
                    }
                });

                // Drag and Drop
                dayColumn.addEventListener('dragover', e => e.preventDefault());
                dayColumn.addEventListener('drop', e => {
                    e.preventDefault();
                    const eventId = parseInt(e.dataTransfer.getData('text/plain'));
                    const droppedOnDate = e.currentTarget.dataset.date;
                    const droppedOnHour = Math.floor(e.offsetY / 60) + (Math.round((e.offsetY % 60) / 15) * 15) / 60;
                    
                    const eventIndex = events.findIndex(ev => ev.id === eventId);
                    if (eventIndex === -1) return;
                    
                    const event = events[eventIndex];
                    const originalStart = new Date(event.start);
                    const originalEnd = new Date(event.end);
                    const duration = originalEnd.getTime() - originalStart.getTime();

                    const newStart = new Date(droppedOnDate);
                    newStart.setHours(Math.floor(droppedOnHour), (droppedOnHour % 1) * 60, 0, 0);
                    
                    const newEnd = new Date(newStart.getTime() + duration);

                    events[eventIndex].start = newStart.toISOString();
                    events[eventIndex].end = newEnd.toISOString();
                    
                    saveEvents();
                    render();
                });

                return dayColumn;
            }


            function renderEvents() {
                 document.querySelectorAll('.event-card').forEach(e => e.remove());
                 const searchTerm = document.getElementById('search-bar').value.toLowerCase();
                 
                 const filteredEvents = events.filter(event => {
                    const titleMatch = event.title.toLowerCase().includes(searchTerm);
                    const noteMatch = event.notes && event.notes.toLowerCase().includes(searchTerm);
                    return searchTerm ? (titleMatch || noteMatch) : true;
                 });


                 filteredEvents.forEach(event => {
                    const eventStart = new Date(event.start);
                    
                    if (currentView === 'monthly') {
                        const cell = calendarBody.querySelector(`[data-date='${eventStart.toISOString().split('T')[0]}']`);
                        if (cell) {
                            const eventPill = document.createElement('div');
                            eventPill.textContent = event.title;
                            eventPill.className = 'text-xs p-1 rounded text-white truncate cursor-pointer';
                            eventPill.style.backgroundColor = event.customColor || categories.find(c => c.name === event.category)?.color;
                            eventPill.addEventListener('click', (e) => {
                                e.stopPropagation();
                                openModal(null, null, event.id);
                            });
                            cell.appendChild(eventPill);
                        }
                        return;
                    }

                    const eventEnd = new Date(event.end);
                    
                    const dayColumn = calendarBody.querySelector(`[data-date='${eventStart.toISOString().split('T')[0]}']`);
                    if (!dayColumn) return;

                    const startHour = eventStart.getHours() + eventStart.getMinutes() / 60;
                    const endHour = eventEnd.getHours() + eventEnd.getMinutes() / 60;

                    const eventCard = document.createElement('div');
                    eventCard.className = 'event-card';
                    eventCard.draggable = true;
                    if(event.isCompleted) eventCard.classList.add('completed');
                    
                    eventCard.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', event.id);
                        e.dataTransfer.effectAllowed = 'move';
                    });

                    eventCard.style.backgroundColor = event.customColor || categories.find(c => c.name === event.category)?.color;
                    eventCard.style.top = `${startHour * 60}px`;
                    eventCard.style.height = `${(endHour - startHour) * 60}px`;

                    const tasksDone = event.tasks && event.tasks.every(t => t.completed);
                    const taskIconColor = tasksDone ? '#10b981' : '#ffffff'; // Green if done, white if not

                    eventCard.innerHTML = `
                        <div class="font-bold truncate">${event.title}</div>
                        <div class="event-icons">
                            <svg data-action="info" fill="white" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9 9a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1zm1-4a1 1 0 011 1v3a1 1 0 11-2 0V6a1 1 0 011-1z"></path></svg>
                            <svg data-action="task" fill="${taskIconColor}" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 .5a.5.5 0 00-1 0v1a.5.5 0 001 0v-1zM7 8.5a.5.5 0 01.5-.5h5a.5.5 0 010 1h-5a.5.5 0 01-.5-.5zm-1.496-.854a.5.5 0 010 .708l-1.5 1.5a.5.5 0 01-.708 0l-.5-.5a.5.5 0 11.708-.708l.146.147 1.146-1.147a.5.5 0 01.708 0zM7 11.5a.5.5 0 01.5-.5h5a.5.5 0 010 1h-5a.5.5 0 01-.5-.5zm-1.496-.854a.5.5 0 010 .708l-1.5 1.5a.5.5 0 01-.708 0l-.5-.5a.5.5 0 11.708-.708l.146.147 1.146-1.147a.5.5 0 01.708 0z"></path></svg>
                            <svg data-action="check" fill="white" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"></path></svg>
                        </div>
                    `;
                    eventCard.addEventListener('click', (e) => {
                        const action = e.target.closest('svg')?.dataset.action;
                        if (action) {
                            e.stopPropagation(); // prevent modal from opening
                            handleIconClick(action, event.id);
                        } else {
                            openModal(null, null, event.id);
                        }
                    });
                    
                    dayColumn.appendChild(eventCard);
                });
            }


            // --- MODAL & EVENT HANDLING ---
            function openModal(date, offsetY, eventId = null) {
                eventForm.reset();
                allDayCheckbox.checked = false;
                timeInputs.style.display = 'grid';
                editingEventId = eventId;
                
                if (eventId) {
                    const event = events.find(e => e.id === eventId);
                    modalTitle.textContent = 'Edit Event';
                    document.getElementById('event-id').value = event.id;
                    document.getElementById('event-title').value = event.title;
                    const startDate = new Date(event.start);
                    document.getElementById('start-time').value = `${startDate.getHours().toString().padStart(2, '0')}:${startDate.getMinutes().toString().padStart(2, '0')}`;
                    document.getElementById('end-time').value = new Date(event.end).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
                    document.getElementById('event-date').value = startDate.toISOString().split('T')[0];
                    document.getElementById('recurrence').value = event.recurrence || 'none';
                    document.getElementById('custom-color').value = event.customColor || '#000000';
                    allDayCheckbox.checked = event.isAllDay;
                    if(event.isAllDay) timeInputs.style.display = 'none';
                    renderCategories(event.category);
                    deleteButton.classList.remove('hidden');
                } else {
                    modalTitle.textContent = 'New Event';
                    if (offsetY) {
                         const hour = Math.floor(offsetY / 60);
                         document.getElementById('start-time').value = `${hour.toString().padStart(2, '0')}:00`;
                         document.getElementById('end-time').value = `${(hour + 1).toString().padStart(2, '0')}:00`;
                    }
                    document.getElementById('event-date').value = date;
                    renderCategories();
                    deleteButton.classList.add('hidden');
                }
                
                eventModal.classList.remove('hidden');
            }

            function closeModal(modal) {
                modal.classList.add('hidden');
            }
            
            function saveEvent(e) {
                e.preventDefault();
                const title = document.getElementById('event-title').value;
                const startTime = document.getElementById('start-time').value;
                const endTime = document.getElementById('end-time').value;
                const date = document.getElementById('event-date').value;
                const categoryRadio = document.querySelector('input[name="category"]:checked');
                const isAllDay = allDayCheckbox.checked;
                const recurrence = document.getElementById('recurrence').value;
                const customColor = document.getElementById('custom-color').value === '#000000' ? null : document.getElementById('custom-color').value;

                if (!categoryRadio) {
                    alert("Please select a category.");
                    return;
                }

                const category = categories.find(c => c.name === categoryRadio.value);
                
                const startDateTime = new Date(`${date}T${isAllDay ? '00:00:00' : startTime}`);
                const endDateTime = new Date(`${date}T${isAllDay ? '23:59:59' : endTime}`);

                if(!isAllDay && endDateTime <= startDateTime) {
                    alert("End time must be after start time.");
                    return;
                }
                
                const newEventData = {
                    title,
                    start: startDateTime.toISOString(),
                    end: endDateTime.toISOString(),
                    category: category.name,
                    color: category.color,
                    isAllDay, recurrence, customColor,
                    notes: '', tasks: [], isCompleted: false
                };

                if (editingEventId) {
                    const eventIndex = events.findIndex(e => e.id === editingEventId);
                    // Preserve existing notes/tasks when editing
                    const existingEvent = events[eventIndex];
                    events[eventIndex] = { ...existingEvent, ...newEventData };
                } else {
                    events.push({ id: Date.now(), ...newEventData });
                }
                
                saveEvents();
                closeModal(eventModal);
                render();
            }

            function handleIconClick(action, eventId) {
                editingEventId = eventId;
                const event = events.find(e => e.id === eventId);
                
                switch (action) {
                    case 'info':
                        document.getElementById('info-modal-title').textContent = event.title;
                        document.getElementById('info-textarea').value = event.notes || '';
                        infoModal.classList.remove('hidden');
                        break;
                    case 'task':
                        document.getElementById('task-modal-title').textContent = event.title;
                        renderTasks(event.tasks || []);
                        taskModal.classList.remove('hidden');
                        break;
                    case 'check':
                        event.isCompleted = !event.isCompleted;
                        saveEvents();
                        render();
                        break;
                }
            }
            
            function saveEvents() {
                 localStorage.setItem('agendaEvents_v2', JSON.stringify(events));
            }


            // --- Task & Info Modal Logic ---
            function renderTasks(tasks) {
                const taskList = document.getElementById('task-list');
                taskList.innerHTML = '';
                tasks.forEach((task, index) => {
                    const taskEl = document.createElement('div');
                    taskEl.className = 'flex items-center gap-2';
                    taskEl.innerHTML = `
                        <input type="checkbox" data-index="${index}" ${task.completed ? 'checked' : ''} class="w-4 h-4">
                        <span class="${task.completed ? 'line-through text-gray-500' : ''}">${task.text}</span>
                    `;
                    taskList.appendChild(taskEl);
                });
            }

            function addEventListeners() {
                // View switchers
                document.getElementById('daily-view-btn').addEventListener('click', () => switchView('daily'));
                document.getElementById('weekly-view-btn').addEventListener('click', () => switchView('weekly'));
                document.getElementById('monthly-view-btn').addEventListener('click', () => switchView('monthly'));

                // Navigation
                document.getElementById('prev-btn').addEventListener('click', () => {
                    if (currentView === 'daily') currentDate.setDate(currentDate.getDate() - 1);
                    if (currentView === 'weekly') currentDate.setDate(currentDate.getDate() - 7);
                    if (currentView === 'monthly') currentDate.setMonth(currentDate.getMonth() - 1);
                    render();
                });
                document.getElementById('next-btn').addEventListener('click', () => {
                    if (currentView === 'daily') currentDate.setDate(currentDate.getDate() + 1);
                    if (currentView === 'weekly') currentDate.setDate(currentDate.getDate() + 7);
                    if (currentView === 'monthly') currentDate.setMonth(currentDate.getMonth() + 1);
                    render();
                });

                // Main event modal
                eventForm.addEventListener('submit', saveEvent);
                document.getElementById('cancel-event').addEventListener('click', () => closeModal(eventModal));
                deleteButton.addEventListener('click', () => {
                   events = events.filter(e => e.id !== editingEventId);
                   saveEvents();
                   closeModal(eventModal);
                   render();
                });
                allDayCheckbox.addEventListener('change', () => {
                    timeInputs.style.display = allDayCheckbox.checked ? 'none' : 'grid';
                });
                
                // Task Modal
                document.getElementById('close-task-modal').addEventListener('click', () => closeModal(taskModal));
                document.getElementById('add-task-btn').addEventListener('click', () => {
                    const input = document.getElementById('new-task-input');
                    const event = events.find(e => e.id === editingEventId);
                    if (input.value && event) {
                        if (!event.tasks) event.tasks = [];
                        event.tasks.push({ text: input.value, completed: false });
                        input.value = '';
                        saveEvents();
                        renderTasks(event.tasks);
                        render(); // To update icon color
                    }
                });
                document.getElementById('task-list').addEventListener('change', e => {
                    if (e.target.type === 'checkbox') {
                         const event = events.find(e => e.id === editingEventId);
                         const taskIndex = e.target.dataset.index;
                         if (event && event.tasks[taskIndex]) {
                            event.tasks[taskIndex].completed = e.target.checked;
                            saveEvents();
                            renderTasks(event.tasks);
                            render(); // To update icon color
                         }
                    }
                });

                // Info Modal
                document.getElementById('cancel-info-modal').addEventListener('click', () => closeModal(infoModal));
                document.getElementById('save-info-modal').addEventListener('click', () => {
                    const event = events.find(e => e.id === editingEventId);
                    if(event) {
                        event.notes = document.getElementById('info-textarea').value;
                        saveEvents();
                        closeModal(infoModal);
                    }
                });

                // Search bar
                document.getElementById('search-bar').addEventListener('input', render);
                
                // Download PNG
                document.getElementById('download-png').addEventListener('click', () => {
                    html2canvas(document.getElementById('calendar-container')).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `agenda-${currentDate.toISOString().split('T')[0]}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                    });
                });
            }
            
            // --- HELPER & UTIL FUNCTIONS ---
            function switchView(view) {
                currentView = view;
                const buttons = ['daily-view-btn', 'weekly-view-btn', 'monthly-view-btn'];
                buttons.forEach(id => {
                    const btn = document.getElementById(id);
                    btn.classList.remove('bg-blue-500', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                });
                const activeBtn = document.getElementById(`${view}-view-btn`);
                activeBtn.classList.add('bg-blue-500', 'text-white');
                activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
                render();
            }

            function getWeekStart(date) {
                const d = new Date(date);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Monday is the first day of the week
                return new Date(d.setDate(diff));
            }

            function renderCategories(selectedCategoryName = null) {
                const categoryPicker = document.getElementById('category-picker');
                categoryPicker.innerHTML = '';
                categories.forEach(cat => {
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = 'category';
                    radio.value = cat.name;
                    radio.id = `cat-${cat.name}`;
                    radio.className = 'sr-only peer';
                    if (cat.name === selectedCategoryName) radio.checked = true;

                    const label = document.createElement('label');
                    label.htmlFor = `cat-${cat.name}`;
                    label.textContent = cat.name;
                    label.className = 'px-3 py-1.5 rounded-full text-sm font-medium cursor-pointer transition-all';
                    label.style.backgroundColor = cat.color;
                    label.style.color = '#ffffff';
                    label.classList.add('peer-checked:ring-2', 'peer-checked:ring-offset-2');
                    label.style.setProperty('--tw-ring-color', cat.color);

                    categoryPicker.appendChild(radio);
                    categoryPicker.appendChild(label);
                });
            }
            
            function updateStats() {
                // This function remains largely the same
                statsContainer.innerHTML = '';
                const stats = {};
                categories.forEach(cat => stats[cat.name] = 0);

                const weekStart = getWeekStart(currentDate);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 7);

                const weekEvents = events.filter(event => {
                    const eventStart = new Date(event.start);
                    return eventStart >= weekStart && eventStart < weekEnd;
                });

                weekEvents.forEach(event => {
                    if (event.isAllDay) {
                        stats[event.category] += 24;
                    } else {
                        const duration = (new Date(event.end) - new Date(event.start)) / (1000 * 60 * 60);
                        stats[event.category] += duration;
                    }
                });
                
                const totalHours = Object.values(stats).reduce((sum, hours) => sum + hours, 0);

                const statsGrid = document.createElement('div');
                statsGrid.className = 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4';

                for (const [category, hours] of Object.entries(stats)) {
                    const percentage = totalHours > 0 ? (hours / totalHours * 100).toFixed(1) : 0;
                    const catColor = categories.find(c => c.name === category).color;

                    const statCard = `
                        <div class="p-4 rounded-lg" style="background-color: ${catColor}33;">
                           <div class="flex items-center">
                             <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${catColor};"></div>
                             <h3 class="font-semibold text-gray-800">${category}</h3>
                           </div>
                           <p class="text-2xl font-bold mt-2 text-gray-900">${hours.toFixed(1)} hrs</p>
                           <p class="text-sm text-gray-600">${percentage}% of total</p>
                        </div>
                    `;
                    statsGrid.innerHTML += statCard;
                }
                statsContainer.appendChild(statsGrid);
            }

            initApp();
        });
    </script>
</body>
</html>
