<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Agenda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: auto repeat(7, 1fr);
            grid-template-rows: repeat(24, 60px);
        }
        .time-label {
            grid-column: 1;
            text-align: right;
            padding-right: 10px;
            font-size: 12px;
            color: #6b7280;
            position: relative;
            top: -8px;
        }
        .day-column {
            position: relative;
            border-right: 1px solid #e5e7eb;
            border-top: 1px solid #e5e7eb;
        }
        .event-card {
            position: absolute;
            width: 100%;
            z-index: 10;
            padding: 4px;
            overflow: hidden;
            border-radius: 4px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .event-card:hover {
            opacity: 0.8;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header -->
    <header class="bg-white shadow-md p-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-800">My Agenda</h1>
        <div>
            <button id="prev-week" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-l">
                &lt;
            </button>
            <button id="next-week" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-r">
                &gt;
            </button>
            <button id="download-png" class="ml-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                Download as PNG
            </button>
        </div>
    </header>

    <main id="calendar-container" class="p-4">
        <!-- Week Header -->
        <div class="grid grid-cols-[auto_repeat(7,_1fr)] text-center font-bold text-gray-600 mb-2">
            <div class="time-col"></div>
            <div id="day-header-0">Sun</div>
            <div id="day-header-1">Mon</div>
            <div id="day-header-2">Tue</div>
            <div id="day-header-3">Wed</div>
            <div id="day-header-4">Thu</div>
            <div id="day-header-5">Fri</div>
            <div id="day-header-6">Sat</div>
        </div>

        <!-- Calendar Grid -->
        <div id="calendar-grid" class="calendar-grid bg-white rounded-lg shadow">
            <!-- Time labels and day columns will be generated by JavaScript -->
        </div>
    </main>
    
    <!-- Statistics Section -->
    <section class="p-4">
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Weekly Statistics</h2>
            <div id="stats-container">
                <!-- Stats will be generated by JavaScript -->
            </div>
        </div>
    </section>

    <!-- Event Modal -->
    <div id="event-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">New Event</h2>
            <form id="event-form">
                <input type="hidden" id="event-id">
                <div class="mb-4">
                    <label for="event-title" class="block text-gray-700 font-medium mb-2">Event Title</label>
                    <input type="text" id="event-title" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="start-time" class="block text-gray-700 font-medium mb-2">Start Time</label>
                        <input type="time" id="start-time" class="w-full border border-gray-300 p-2 rounded-lg" required step="900">
                    </div>
                    <div>
                        <label for="end-time" class="block text-gray-700 font-medium mb-2">End Time</label>
                        <input type="time" id="end-time" class="w-full border border-gray-300 p-2 rounded-lg" required step="900">
                    </div>
                </div>
                <input type="hidden" id="event-date">
                 <div class="mb-6">
                    <label class="block text-gray-700 font-medium mb-2">Category</label>
                    <div id="category-picker" class="flex flex-wrap gap-2">
                        <!-- Category options will be generated by JavaScript -->
                    </div>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="delete-event" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg hidden">Delete</button>
                    <button type="button" id="cancel-event" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const calendarGrid = document.getElementById('calendar-grid');
            const eventModal = document.getElementById('event-modal');
            const eventForm = document.getElementById('event-form');
            const modalTitle = document.getElementById('modal-title');
            const deleteButton = document.getElementById('delete-event');
            const statsContainer = document.getElementById('stats-container');

            let currentWeek = new Date();
            let events = JSON.parse(localStorage.getItem('agendaEvents')) || [];
            let editingEventId = null;

            const categories = [
                { name: 'Sleep', color: '#1e3a8a' }, // dark blue
                { name: 'Work', color: '#b91c1c' },  // red
                { name: 'Leisure', color: '#047857' },// green
                { name: 'Exercise', color: '#7c3aed' },// violet
                { name: 'Other', color: '#6b7280' }  // gray
            ];

            function initNotifications() {
                if ('Notification' in window && Notification.permission !== 'denied') {
                    Notification.requestPermission();
                }
            }

            function scheduleNotifications() {
                const now = new Date();
                events.forEach(event => {
                    const eventStart = new Date(event.start);
                    // Notify 5 minutes before
                    const notificationTime = new Date(eventStart.getTime() - 5 * 60000); 
                    if (notificationTime > now) {
                        const timeUntilNotification = notificationTime.getTime() - now.getTime();
                        setTimeout(() => {
                            if (Notification.permission === 'granted') {
                                new Notification(event.title, {
                                    body: `Starts at ${eventStart.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`,
                                    icon: 'https://placehold.co/32x32/000000/FFFFFF?text=ðŸ””'
                                });
                            }
                        }, timeUntilNotification);
                    }
                });
            }

            function renderWeek() {
                calendarGrid.innerHTML = '';
                const weekStart = getWeekStart(currentWeek);

                // Render time labels
                for (let hour = 0; hour < 24; hour++) {
                    const timeLabel = document.createElement('div');
                    timeLabel.className = 'time-label';
                    timeLabel.textContent = `${hour.toString().padStart(2, '0')}:00`;
                    timeLabel.style.gridRow = hour + 1;
                    calendarGrid.appendChild(timeLabel);
                }
                
                // Render day columns and headers
                for (let i = 0; i < 7; i++) {
                    const day = new Date(weekStart);
                    day.setDate(weekStart.getDate() + i);
                    
                    const dayHeader = document.getElementById(`day-header-${i}`);
                    dayHeader.textContent = `${day.toLocaleDateString('en-US', { weekday: 'short' })} ${day.getDate()}`;
                    
                    const dayColumn = document.createElement('div');
                    dayColumn.className = 'day-column';
                    dayColumn.dataset.date = day.toISOString().split('T')[0];
                    dayColumn.style.gridColumn = i + 2;
                    dayColumn.style.gridRow = '1 / 25';
                    dayColumn.addEventListener('click', (e) => {
                        if (e.target === dayColumn) {
                            openModal(day.toISOString().split('T')[0], e.offsetY);
                        }
                    });
                    calendarGrid.appendChild(dayColumn);
                }
                renderEvents();
                updateStats();
                scheduleNotifications();
            }

            function renderEvents() {
                // Clear existing event elements
                document.querySelectorAll('.event-card').forEach(e => e.remove());

                const weekStart = getWeekStart(currentWeek);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 7);

                const weekEvents = events.filter(event => {
                    const eventStart = new Date(event.start);
                    return eventStart >= weekStart && eventStart < weekEnd;
                });

                weekEvents.forEach(event => {
                    const eventStart = new Date(event.start);
                    const eventEnd = new Date(event.end);
                    
                    const dayIndex = eventStart.getDay();
                    const startHour = eventStart.getHours() + eventStart.getMinutes() / 60;
                    const endHour = eventEnd.getHours() + eventEnd.getMinutes() / 60;

                    const eventCard = document.createElement('div');
                    eventCard.className = 'event-card';
                    eventCard.textContent = event.title;
                    eventCard.style.backgroundColor = event.color;
                    eventCard.style.top = `${startHour * 60}px`;
                    eventCard.style.height = `${(endHour - startHour) * 60}px`;
                    
                    eventCard.addEventListener('click', () => openModal(null, null, event.id));

                    const dayColumn = calendarGrid.querySelector(`[data-date='${eventStart.toISOString().split('T')[0]}']`);
                    if (dayColumn) {
                       dayColumn.appendChild(eventCard);
                    }
                });
            }

            function getWeekStart(date) {
                const d = new Date(date);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 0); // Adjust for Sunday start
                return new Date(d.setDate(diff));
            }
            
            function openModal(date, offsetY, eventId = null) {
                eventForm.reset();
                editingEventId = eventId;
                
                if (eventId) {
                    const event = events.find(e => e.id === eventId);
                    modalTitle.textContent = 'Edit Event';
                    document.getElementById('event-id').value = event.id;
                    document.getElementById('event-title').value = event.title;
                    const startDate = new Date(event.start);
                    const endDate = new Date(event.end);
                    document.getElementById('start-time').value = `${startDate.getHours().toString().padStart(2, '0')}:${startDate.getMinutes().toString().padStart(2, '0')}`;
                    document.getElementById('end-time').value = `${endDate.getHours().toString().padStart(2, '0')}:${endDate.getMinutes().toString().padStart(2, '0')}`;
                    document.getElementById('event-date').value = startDate.toISOString().split('T')[0];
                    renderCategories(event.category);
                    deleteButton.classList.remove('hidden');
                } else {
                    modalTitle.textContent = 'New Event';
                    const hour = Math.floor(offsetY / 60);
                    document.getElementById('start-time').value = `${hour.toString().padStart(2, '0')}:00`;
                    document.getElementById('end-time').value = `${(hour + 1).toString().padStart(2, '0')}:00`;
                    document.getElementById('event-date').value = date;
                    renderCategories();
                    deleteButton.classList.add('hidden');
                }
                
                eventModal.classList.remove('hidden');
                eventModal.style.opacity = 1;
            }

            function closeModal() {
                eventModal.style.opacity = 0;
                setTimeout(() => eventModal.classList.add('hidden'), 300);
            }

            function renderCategories(selectedCategoryName = null) {
                const categoryPicker = document.getElementById('category-picker');
                categoryPicker.innerHTML = '';
                categories.forEach(cat => {
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = 'category';
                    radio.value = cat.name;
                    radio.id = `cat-${cat.name}`;
                    radio.className = 'sr-only peer';
                    if (cat.name === selectedCategoryName) {
                        radio.checked = true;
                    }

                    const label = document.createElement('label');
                    label.htmlFor = `cat-${cat.name}`;
                    label.textContent = cat.name;
                    label.className = 'px-3 py-1.5 rounded-full text-sm font-medium cursor-pointer transition-all';
                    label.style.backgroundColor = cat.color;
                    label.style.color = '#ffffff';
                    label.classList.add('peer-checked:ring-2', 'peer-checked:ring-offset-2');
                    label.style.setProperty('--tw-ring-color', cat.color);

                    categoryPicker.appendChild(radio);
                    categoryPicker.appendChild(label);
                });
            }

            function saveEvent(e) {
                e.preventDefault();
                const title = document.getElementById('event-title').value;
                const startTime = document.getElementById('start-time').value;
                const endTime = document.getElementById('end-time').value;
                const date = document.getElementById('event-date').value;
                const categoryRadio = document.querySelector('input[name="category"]:checked');

                if (!categoryRadio) {
                    alert("Please select a category.");
                    return;
                }

                const categoryName = categoryRadio.value;
                const category = categories.find(c => c.name === categoryName);
                
                const startDateTime = new Date(`${date}T${startTime}`);
                const endDateTime = new Date(`${date}T${endTime}`);

                if(endDateTime <= startDateTime) {
                    alert("End time must be after start time.");
                    return;
                }

                if (editingEventId) {
                    const eventIndex = events.findIndex(e => e.id === editingEventId);
                    events[eventIndex] = { ...events[eventIndex], title, start: startDateTime.toISOString(), end: endDateTime.toISOString(), category: category.name, color: category.color };
                } else {
                    events.push({
                        id: Date.now(),
                        title,
                        start: startDateTime.toISOString(),
                        end: endDateTime.toISOString(),
                        category: category.name,
                        color: category.color
                    });
                }
                
                localStorage.setItem('agendaEvents', JSON.stringify(events));
                closeModal();
                renderWeek();
            }

            function updateStats() {
                statsContainer.innerHTML = '';
                const stats = {};
                categories.forEach(cat => stats[cat.name] = 0);

                const weekStart = getWeekStart(currentWeek);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 7);

                const weekEvents = events.filter(event => {
                    const eventStart = new Date(event.start);
                    return eventStart >= weekStart && eventStart < weekEnd;
                });

                weekEvents.forEach(event => {
                    const duration = (new Date(event.end) - new Date(event.start)) / (1000 * 60 * 60); // in hours
                    stats[event.category] += duration;
                });
                
                const totalHours = Object.values(stats).reduce((sum, hours) => sum + hours, 0);

                const statsGrid = document.createElement('div');
                statsGrid.className = 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4';

                for (const [category, hours] of Object.entries(stats)) {
                    const percentage = totalHours > 0 ? (hours / totalHours * 100).toFixed(1) : 0;
                    const catColor = categories.find(c => c.name === category).color;

                    const statCard = `
                        <div class="p-4 rounded-lg" style="background-color: ${catColor}33;">
                           <div class="flex items-center">
                             <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${catColor};"></div>
                             <h3 class="font-semibold text-gray-800">${category}</h3>
                           </div>
                           <p class="text-2xl font-bold mt-2 text-gray-900">${hours.toFixed(1)} hrs</p>
                           <p class="text-sm text-gray-600">${percentage}% of total</p>
                        </div>
                    `;
                    statsGrid.innerHTML += statCard;
                }
                statsContainer.appendChild(statsGrid);
            }

            // Event Listeners
            document.getElementById('prev-week').addEventListener('click', () => {
                currentWeek.setDate(currentWeek.getDate() - 7);
                renderWeek();
            });

            document.getElementById('next-week').addEventListener('click', () => {
                currentWeek.setDate(currentWeek.getDate() + 7);
                renderWeek();
            });
            
            eventForm.addEventListener('submit', saveEvent);
            document.getElementById('cancel-event').addEventListener('click', closeModal);
            deleteButton.addEventListener('click', () => {
                if(confirm('Are you sure you want to delete this event?')) {
                   events = events.filter(e => e.id !== editingEventId);
                   localStorage.setItem('agendaEvents', JSON.stringify(events));
                   closeModal();
                   renderWeek();
                }
            });

            document.getElementById('download-png').addEventListener('click', () => {
                html2canvas(document.getElementById('calendar-container')).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `agenda-${currentWeek.toISOString().split('T')[0]}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                });
            });

            // Initial render
            initNotifications();
            renderWeek();
        });
    </script>
</body>
</html>
